#define TRAP_SAVED_REGS_SIZE 256

#define TRAP_SAVED_REGS_STRUCT_OFFSET_RA  0
#define TRAP_SAVED_REGS_STRUCT_OFFSET_SP  8
#define TRAP_SAVED_REGS_STRUCT_OFFSET_GP  16
#define TRAP_SAVED_REGS_STRUCT_OFFSET_TP  24
#define TRAP_SAVED_REGS_STRUCT_OFFSET_T0  32
#define TRAP_SAVED_REGS_STRUCT_OFFSET_T1  40
#define TRAP_SAVED_REGS_STRUCT_OFFSET_T2  48
#define TRAP_SAVED_REGS_STRUCT_OFFSET_S0  56
#define TRAP_SAVED_REGS_STRUCT_OFFSET_S1  64
#define TRAP_SAVED_REGS_STRUCT_OFFSET_A0  72
#define TRAP_SAVED_REGS_STRUCT_OFFSET_A1  80
#define TRAP_SAVED_REGS_STRUCT_OFFSET_A2  88
#define TRAP_SAVED_REGS_STRUCT_OFFSET_A3  96
#define TRAP_SAVED_REGS_STRUCT_OFFSET_A4  104
#define TRAP_SAVED_REGS_STRUCT_OFFSET_A5  112
#define TRAP_SAVED_REGS_STRUCT_OFFSET_A6  120
#define TRAP_SAVED_REGS_STRUCT_OFFSET_A7  128
#define TRAP_SAVED_REGS_STRUCT_OFFSET_S2  136
#define TRAP_SAVED_REGS_STRUCT_OFFSET_S3  144
#define TRAP_SAVED_REGS_STRUCT_OFFSET_S4  152
#define TRAP_SAVED_REGS_STRUCT_OFFSET_S5  160
#define TRAP_SAVED_REGS_STRUCT_OFFSET_S6  168
#define TRAP_SAVED_REGS_STRUCT_OFFSET_S7  176
#define TRAP_SAVED_REGS_STRUCT_OFFSET_S8  184
#define TRAP_SAVED_REGS_STRUCT_OFFSET_S9  192
#define TRAP_SAVED_REGS_STRUCT_OFFSET_S10 200
#define TRAP_SAVED_REGS_STRUCT_OFFSET_S11 208
#define TRAP_SAVED_REGS_STRUCT_OFFSET_T3  216
#define TRAP_SAVED_REGS_STRUCT_OFFSET_T4  224
#define TRAP_SAVED_REGS_STRUCT_OFFSET_T5  232
#define TRAP_SAVED_REGS_STRUCT_OFFSET_T6  240
#define TRAP_SAVED_REGS_STRUCT_OFFSET_PC  248

#define TRAP_SAVED_REGS_STRUCT_PRE_ALLOC_OFFSET_SP -248

.text
  .global trap_handler_wrapper

.align 4
trap_handler_wrapper:
setup_stack:
  // save sp in the not yet allocated trap_saved_regs struct
  sd sp, TRAP_SAVED_REGS_STRUCT_PRE_ALLOC_OFFSET_SP(sp)

  // allocate memory for the trap_saved_regs struct
  addi sp, sp, -TRAP_SAVED_REGS_SIZE

save_regs:
  sd ra,  TRAP_SAVED_REGS_STRUCT_OFFSET_RA(sp)
  sd gp,  TRAP_SAVED_REGS_STRUCT_OFFSET_GP(sp)
  sd tp,  TRAP_SAVED_REGS_STRUCT_OFFSET_TP(sp)
  sd t0,  TRAP_SAVED_REGS_STRUCT_OFFSET_T0(sp)
  sd t1,  TRAP_SAVED_REGS_STRUCT_OFFSET_T1(sp)
  sd t2,  TRAP_SAVED_REGS_STRUCT_OFFSET_T2(sp)
  sd s0,  TRAP_SAVED_REGS_STRUCT_OFFSET_S0(sp)
  sd s1,  TRAP_SAVED_REGS_STRUCT_OFFSET_S1(sp)
  sd a0,  TRAP_SAVED_REGS_STRUCT_OFFSET_A0(sp)
  sd a1,  TRAP_SAVED_REGS_STRUCT_OFFSET_A1(sp)
  sd a2,  TRAP_SAVED_REGS_STRUCT_OFFSET_A2(sp)
  sd a3,  TRAP_SAVED_REGS_STRUCT_OFFSET_A3(sp)
  sd a4,  TRAP_SAVED_REGS_STRUCT_OFFSET_A4(sp)
  sd a5,  TRAP_SAVED_REGS_STRUCT_OFFSET_A5(sp)
  sd a6,  TRAP_SAVED_REGS_STRUCT_OFFSET_A6(sp)
  sd a7,  TRAP_SAVED_REGS_STRUCT_OFFSET_A7(sp)
  sd s2,  TRAP_SAVED_REGS_STRUCT_OFFSET_S2(sp)
  sd s3,  TRAP_SAVED_REGS_STRUCT_OFFSET_S3(sp)
  sd s4,  TRAP_SAVED_REGS_STRUCT_OFFSET_S4(sp)
  sd s5,  TRAP_SAVED_REGS_STRUCT_OFFSET_S5(sp)
  sd s6,  TRAP_SAVED_REGS_STRUCT_OFFSET_S6(sp)
  sd s7,  TRAP_SAVED_REGS_STRUCT_OFFSET_S7(sp)
  sd s8,  TRAP_SAVED_REGS_STRUCT_OFFSET_S8(sp)
  sd s9,  TRAP_SAVED_REGS_STRUCT_OFFSET_S9(sp)
  sd s10, TRAP_SAVED_REGS_STRUCT_OFFSET_S10(sp)
  sd s11, TRAP_SAVED_REGS_STRUCT_OFFSET_S11(sp)
  sd t3,  TRAP_SAVED_REGS_STRUCT_OFFSET_T3(sp)
  sd t4,  TRAP_SAVED_REGS_STRUCT_OFFSET_T4(sp)
  sd t5,  TRAP_SAVED_REGS_STRUCT_OFFSET_T5(sp)
  sd t6,  TRAP_SAVED_REGS_STRUCT_OFFSET_T6(sp)

  // save u-mode pc
  csrr t0, sepc
  sd t0, TRAP_SAVED_REGS_STRUCT_OFFSET_PC(sp)

call_trap_handler:
  call trap_handler

restore_regs:
  // restore u-mode pc
  ld t0, TRAP_SAVED_REGS_STRUCT_OFFSET_PC(sp)
  csrw sepc, t0

  ld ra,  TRAP_SAVED_REGS_STRUCT_OFFSET_RA(sp)
  ld gp,  TRAP_SAVED_REGS_STRUCT_OFFSET_GP(sp)
  ld tp,  TRAP_SAVED_REGS_STRUCT_OFFSET_TP(sp)
  ld t0,  TRAP_SAVED_REGS_STRUCT_OFFSET_T0(sp)
  ld t1,  TRAP_SAVED_REGS_STRUCT_OFFSET_T1(sp)
  ld t2,  TRAP_SAVED_REGS_STRUCT_OFFSET_T2(sp)
  ld s0,  TRAP_SAVED_REGS_STRUCT_OFFSET_S0(sp)
  ld s1,  TRAP_SAVED_REGS_STRUCT_OFFSET_S1(sp)
  ld a0,  TRAP_SAVED_REGS_STRUCT_OFFSET_A0(sp)
  ld a1,  TRAP_SAVED_REGS_STRUCT_OFFSET_A1(sp)
  ld a2,  TRAP_SAVED_REGS_STRUCT_OFFSET_A2(sp)
  ld a3,  TRAP_SAVED_REGS_STRUCT_OFFSET_A3(sp)
  ld a4,  TRAP_SAVED_REGS_STRUCT_OFFSET_A4(sp)
  ld a5,  TRAP_SAVED_REGS_STRUCT_OFFSET_A5(sp)
  ld a6,  TRAP_SAVED_REGS_STRUCT_OFFSET_A6(sp)
  ld a7,  TRAP_SAVED_REGS_STRUCT_OFFSET_A7(sp)
  ld s2,  TRAP_SAVED_REGS_STRUCT_OFFSET_S2(sp)
  ld s3,  TRAP_SAVED_REGS_STRUCT_OFFSET_S3(sp)
  ld s4,  TRAP_SAVED_REGS_STRUCT_OFFSET_S4(sp)
  ld s5,  TRAP_SAVED_REGS_STRUCT_OFFSET_S5(sp)
  ld s6,  TRAP_SAVED_REGS_STRUCT_OFFSET_S6(sp)
  ld s7,  TRAP_SAVED_REGS_STRUCT_OFFSET_S7(sp)
  ld s8,  TRAP_SAVED_REGS_STRUCT_OFFSET_S8(sp)
  ld s9,  TRAP_SAVED_REGS_STRUCT_OFFSET_S9(sp)
  ld s10, TRAP_SAVED_REGS_STRUCT_OFFSET_S10(sp)
  ld s11, TRAP_SAVED_REGS_STRUCT_OFFSET_S11(sp)
  ld t3,  TRAP_SAVED_REGS_STRUCT_OFFSET_T3(sp)
  ld t4,  TRAP_SAVED_REGS_STRUCT_OFFSET_T4(sp)
  ld t5,  TRAP_SAVED_REGS_STRUCT_OFFSET_T5(sp)
  ld t6,  TRAP_SAVED_REGS_STRUCT_OFFSET_T6(sp)

restore_stack:
  ld sp, TRAP_SAVED_REGS_STRUCT_OFFSET_SP(sp)

return_to_umode:
  sret
